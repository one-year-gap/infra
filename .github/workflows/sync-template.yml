name: Central Template Sync

on:
  push:
    branches: [main]
    paths:
      - 'templates/github/**'

jobs:
  distribute:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Central Repo
        uses: actions/checkout@v4

      - name: Sync Templates to Service Repos
        uses: actions/github-script@v7
        env:
          SYNC_TOKEN: ${{ secrets.CENTRAL_SYNC_TOKEN }}
        with:
          github-token: ${{ env.SYNC_TOKEN }}
          script: |
            const fs = require('fs');

            const targetRepos = ['api-server','counselor-fe','admin-fe','customer-fe','infra','worker','docs'];
            const targetBranch = 'dev';

            // --- source templates (central repo) ---
            const issueTemplate = fs.readFileSync('templates/github/ISSUE_TEMPLATE/issue-form.yml', 'utf8');

            // PR templates (multiple) -> put under .github/PULL_REQUEST_TEMPLATE/
            const prDefault = fs.readFileSync('templates/github/PULL_REQUEST_TEMPLATE/default.md', 'utf8');
            const prDeploy  = fs.readFileSync('templates/github/PULL_REQUEST_TEMPLATE/deploy.md', 'utf8');

            for (const repoName of targetRepos) {
              const [owner, repo] = [context.repo.owner, repoName];

              // 1) Issue form
              await upsertFile(owner, repo,
                '.github/ISSUE_TEMPLATE/issue-form.yml',
                'chore: sync issue template from infra',
                issueTemplate,
                targetBranch
              );

              // 2) PR template - default
              await upsertFile(owner, repo,
                '.github/PULL_REQUEST_TEMPLATE/default.md',
                'chore: sync PR template (default) from infra',
                prDefault,
                targetBranch
              );

              await upsertFile(owner, repo,
                '.github/pull_request_template.md',
                'chore: sync PR template (default) from infra',
                prDefault,
                targetBranch
              );

              // 3) PR template - deploy
              await upsertFile(owner, repo,
                '.github/PULL_REQUEST_TEMPLATE/deploy.md',
                'chore: sync PR template (deploy) from infra',
                prDeploy,
                targetBranch
              );
              
            }

            async function upsertFile(owner, repo, path, message, raw, branch) {
              const sha = await getSha(owner, repo, path, branch);
              await github.rest.repos.createOrUpdateFileContents({
                owner, repo, path,
                message,
                content: Buffer.from(raw).toString('base64'),
                sha,
                branch
              });
            }

            async function getSha(owner, repo, path, branch) {
              try {
                const res = await github.rest.repos.getContent({ owner, repo, path, ref: branch });
                return res.data.sha;
              } catch (e) {
                return undefined;
              }
            }

